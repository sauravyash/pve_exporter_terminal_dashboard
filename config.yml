version: 1
terminal:
  font:
    prefix: Uni2
    fontface: TerminusBold
    fontsize: 24x12
datasources:
  prometheus:
    base_url: http://192.168.1.24:9090
    timeout_s: 3.0
globals:
  refresh:
    fast_s: 0.2
    bulk_s: 5.0
  vars:
    node_id: node/r440
  defaults:
    missing_value: '---'
    formats:
      percent: '%.1f%%'
      number: '%.1f'
      kb: '%.1f KB'
      mb: '%.1f MB'
      temp_c: '%.0fÂ°C'
metrics:
  - id: host_cpu_decimal
    query: 'pve_cpu_usage_ratio{id="${node_id}"}'
    query_type: instant

  - id: host_mem_used
    query: 'pve_memory_usage_bytes{id="${node_id}"}'
    query_type: instant

  - id: host_mem_total
    query: 'pve_memory_size_bytes{id="${node_id}"}'
    query_type: instant

  - id: nvme_temp
    query: nvme_temperature_celsius
    query_type: instant

  - id: guest_info
    query: |
      (
        (pve_lock_state == 1)
        or
        ((pve_ha_state == 1) unless on (id) (pve_lock_state == 1))
        or
        (
          label_replace(pve_up == 1, "state", "running", "id", ".*")
          or
          label_replace(pve_up == 0, "state", "stopped", "id", ".*")
        ) unless on (id) ((pve_lock_state == 1) or (pve_ha_state == 1))
      )
      * on (id) group_left(name,node,type)
      pve_guest_info

    query_type: instant
    expose_labels:
      - id
      - name
      - type
      - state

  - id: guest_cpu
    query: pve_cpu_usage_ratio
    query_type: instant

  - id: guest_mem_used
    query: pve_memory_usage_bytes
    query_type: instant

  - id: guest_mem_total
    query: pve_memory_size_bytes
    query_type: instant

  - id: guest_disk_read
    query: rate(pve_disk_read_bytes[5m])
    query_type: instant

  - id: guest_disk_write
    query: rate(pve_disk_write_bytes[5m])
    query_type: instant

  - id: guest_net_in
    query: rate(pve_network_receive_bytes[5m])
    query_type: instant

  - id: guest_net_out
    query: rate(pve_network_transmit_bytes[5m])
    query_type: instant

  - id: mc_player_list
    query: |
      minecraft_player_online
      or
      # --- Synthetic "none" player when server is online but empty ---
      (
        (
          (minecraft_query_up == 1 or minecraft_status_up == 1)
        )
        * on(instance, job) group_right()
        (
          label_replace(
            minecraft_query_up,
            "player", "[None]",
            "instance", ".*"
          )
          unless on(instance, job) minecraft_player_online
        )
      )
      or
      # --- Synthetic "server_offline" player when both are 0 ---
      (
        (
          (minecraft_query_up == 0)
          and on(instance, job) (minecraft_status_up == 0)
        )
        * on(instance, job) group_right()
        label_replace(
          minecraft_query_up,
          "player", "[Server Offline]",
          "instance", ".*"
        )
      )

    query_type: instant
    expose_labels:
      - player

derived:
  - id: host_cpu
    expr: 100 * host_cpu_decimal

  - id: host_mem_pct
    expr: 100 * host_mem_used / host_mem_total

  - id: guest_cpu_pct
    per_row: true
    expr: 100 * guest_cpu

  - id: guest_mem_pct
    per_row: true
    expr: 100 * guest_mem_used / guest_mem_total

views:
  - id: host_header
    type: header
    title: Host Summary
    template: '${uptime} \n${colors.bright.green}CPU${colors.reset}: ${host_cpu|percent:1}  ${colors.bright.blue}MEM${colors.reset}:
      ${host_mem_pct|percent:1}  ${colors.bright.yellow}VMs${colors.reset}:${vm_count}  ${colors.bright.magenta}NVMe${colors.reset}:${nvme_temp|temp_c:0}'
    computed_values:
      vm_count:
        from_metric: guest_info
        op: count
      uptime:
        builtin: uptime
  - id: guest_table
    type: table
    title: VMs and Containers
    source:
      rows_from:
        anchor_metric: guest_info
        join_on_label: id
      preferred_labels:
        name: name
        type: type
      sort:
        by: guest_cpu_pct
        order: desc
    columns:
      - id: name
        title: ${colors.bright.yellow}VM${colors.reset}${colors.bright.magenta}/${colors.reset}${colors.bright.cyan}CT${colors.reset}
        value: ${name}
        style:
          color_by_label:
            type:
              lxc: ${colors.bright.cyan}
              qemu: ${colors.bright.yellow}
          reset: ${colors.reset}
        width: 12

      - id: status
        title: State
        value: ${state}
        width: 12

      - id: cpu
        title: CPU%
        value: ${guest_cpu_pct}
        format: percent
        decimals: 1
        style: {}
        width: 8

      - id: mem
        title: MEM%
        value: ${guest_mem_pct}
        format: percent
        decimals: 1
        style: {}
        width: 8

      - id: read
        title: DiskR
        value: ${guest_disk_read}
        format: -b
        decimals: 1
        style: {}
        width: 8

      - id: write
        title: DiskW
        value: ${guest_disk_write}
        format: -b
        decimals: 1
        style: {}
        width: 8

      - id: netin
        title: NetIn
        value: ${guest_net_in}
        format: -b
        decimals: 1
        style: {}
        width: 8

      - id: netout
        title: NetOut
        value: ${guest_net_out}
        format: -b
        decimals: 1
        style: {}
        width: 8
  
  - id: mc_dash
    title: MC Online Users
    type: list
    source:
      items_from:
        metric: mc_player_list
        labels: [player]
    item:
      template: "${colors.bright.cyan}${player}${colors.reset}"

layout:
  - view: host_header
  - view: guest_table
  - view: mc_dash

colors:
  reset: "\e[0m"
  bright:
    green: "\e[1;32m"
    blue: "\e[1;34m"
    yellow: "\e[1;33m"
    magenta: "\e[1;35m"
    cyan: "\e[1;36m"
    red: "\e[1;31m"
    white: "\e[1;37m"
  roles:
    host_label: ${colors.bright.green}
    mem_label: ${colors.bright.blue}
    vm_label: ${colors.bright.yellow}
    nvme_label: ${colors.bright.magenta}

